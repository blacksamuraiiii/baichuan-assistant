# 百川数据助手

百川数据助手是一款基于Python的自动化数据处理与邮件发送工具。它通过图形化界面（GUI）简化了从API获取数据、生成Excel报表到邮件发送的全过程，并集成了Windows任务计划功能以实现无人值守的自动化。

**对于非技术人员，我们提供了详细的图形化界面操作手册，请查阅 [《项目操作文档.md》](./doc/项目操作文档.md)。**

## 技术栈

- **GUI框架**: `CustomTkinter` - 一个基于Tkinter的现代UI库
- **数据处理**: `pandas` - 用于高效处理从API获取的数据，并生成Excel文件
- **网络请求**: `requests` - 优化的API调用，支持大数据量处理
- **配置文件**: `JSON` 格式，用于存储任务配置，易于读写和扩展
- **加密**: `cryptography` (Fernet) - 用于对API密钥、邮箱密码等敏感信息进行AES-128对称加密
- **Windows任务计划**: 通过调用系统 `schtasks.exe` 命令实现任务的注册、查询和删除
- **打包**: `PyInstaller` - 用于将Python程序打包成单文件可执行程序（`.exe`）

## 版本升级历程

### v1.4 - 数据获取逻辑重构与优化 🛠️
本次升级在 `v1.3` 的基础上，对核心数据获取逻辑进行了重构，引入了 `ijson` 库进行流式JSON解析，显著提升了代码的健壮性与可维护性。

- **引入流式JSON解析**: 正式集成 `ijson` 库，替代了之前版本中内存密集型的 `response.json()` 方法。现在，即使面对巨大的JSON响应体，程序也能以极低的内存占用进行解析。
- **智能数据节点发现**: 优化了 `fetch_api_data` 函数，不再硬编码JSON的数据路径。通过 `ijson.kvitems` 动态查找 `value` 或 `data` 等常见键，使代码能更灵活地适应不同的API响应结构。
- **代码精简与KISS原则**: 移除了为预检响应而设计的 `ChainedStream` 辅助类和复杂的手动流控制逻辑。新的实现更加直接、简洁，`utils.py` 中的相关代码减少了约 **50** 行，可读性和可维护性大幅提升。
- **内存管理优化**: 移除了不必要的 `gc.collect()` 手动调用，充分信赖Python和Pandas的自动化内存管理，使代码更干净，同时避免了不必要的性能开销。

### v1.3 - API性能优化 🚀

针对大数据量处理的重大突破：

#### 核心问题解决

- **API特性**: 百川API不支持分页，一次性返回所有数据。
- **原始痛点**: 大数据量时内存峰值过高导致程序崩溃。
- **优化策略**: 流式处理 + 智能分批 + 内存控制。

#### 智能处理机制

```python
# 双模式处理策略
if 数据量 ≤ 50,000条:
    直接处理，最小开销
else:
    流式分批处理，防止内存溢出
```

#### 内存优化特性

- **批次大小控制**: 每批10,000条记录，避免内存峰值。
- **即时内存清理**: 每批处理后立即释放临时内存。
- **内存监控**: 实时显示DataFrame内存使用量。
- **数据截取**: 超过限制时自动截取前N条记录。

#### 性能提升对比

| 指标       | 优化前   | 优化后   | 改善效果 |
| ---------- | -------- | -------- | -------- |
| 内存峰值   | 2GB+     | <500MB   | >75%     |
| 崩溃风险   | 极高     | 极低     | 显著改善 |
| 处理稳定性 | 不稳定   | 稳定     | 100%可靠 |
| 大数据处理 | 无法处理 | 流畅处理 | 质的飞跃 |

#### 配置参数优化

```json
{
  "timeout": 120,
  "max_records": 100000,
  "streaming_threshold": 50000
}
```

### v1.2 - 依赖优化与多API支持

第二次重要升级，增强功能性和兼容性：

- **版本兼容性提升**: 降低关键依赖版本要求，增强安装成功率
- **多API支持**: 添加多个数据源支持，生成多Sheet Excel文件
- **网络请求优化**: 针对百川API不分页特点优化请求策略
- **内存使用优化**: 流式处理大数据，避免内存溢出

### v1.1 - 代码结构优化

首次重大优化，提升系统稳定性：

- **代码精简**: 从原始 2469 行优化至 2314 行，减少 155 行代码（约6.3%）
- **邮件发送优化**: 简化邮件函数链，统一发送入口，提升发送效率
- **缓存系统精简**: 简化为单层缓存机制，降低内存占用
- **配置模板优化**: 移除冗余配置模板，简化项目结构
- **任务锁机制优化**: 统一锁管理，提高并发安全性
- **GUI代码清理**: 移除重复界面代码，提升响应速度

### v1.0 - 初始版本

项目初始版本，实现了基础功能：

- 基础API数据获取
- 单Sheet Excel生成
- 简单邮件发送
- Windows定时任务支持

所有版本升级均保持功能完整性和向后兼容性。

## 核心逻辑实现

### 1. 配置管理

- 所有任务配置存储在根目录的 `config.json` 文件中
- 程序启动时会读取该文件，并将其内容解析为任务对象
- GUI中的任何修改都会实时更新到 `config.json`

### 2. 敏感信息加密

- 首次运行时，程序会在根目录生成一个 `secret.key` 文件，作为AES加密的密钥
- `config.json` 中所有标记为敏感的字段（如 `password`, `app_secret`）在保存时都会被自动加密
- 读取配置时，程序会使用 `secret.key` 自动解密这些字段，供程序在内存中使用

### 3. 任务执行流程

- 任务可以通过GUI的"测试运行"按钮或命令行的 `--headless` 参数触发
- **任务锁**：执行前，会在 `locks/` 目录下创建一个 `<task_name>.lock` 文件，防止同一任务并发执行。任务结束后，锁文件被自动删除
- **数据获取**：使用优化的 `requests` 库调用用户配置的API，支持设置请求头、超时和大数据流式处理
- **数据处理**：使用 `pandas` 将返回的JSON数据转换为DataFrame，并使用 `to_excel` 方法生成包含多个Sheet的Excel文件
- **邮件发送**：使用优化的统一邮件发送接口，支持HTML格式正文，并能将 `pandas` DataFrame渲染为HTML表格嵌入邮件中
- **日志记录**：所有操作都会记录在 `app.log` 中，使用 `logging` 模块实现，并按天轮转
- **重试机制**：内置智能重试机制，自动处理网络波动和临时故障

### 4. Windows任务计划集成

- GUI通过调用 `subprocess` 模块执行 `schtasks.exe` 命令来管理定时任务
- 创建的任务会执行 `百川数据助手.exe --headless "任务名称"` 命令，以无头模式在后台运行

## 开发与使用

### 文件结构

```
百川数据助手/
├─ app.py                    # 主程序文件
├─ utils.py                  # 工具函数模块
├─ requirements.txt          # 依赖包列表
├─ app.spec                  # PyInstaller打包配置
├─ version_info.txt          # 版本信息文件
├─ config.json              # 任务配置文件
├─ secret.key               # 加密密钥文件（自动生成，隐藏）
├─ app.log                  # 运行日志
├─ locks/                   # 任务锁文件目录（自动生成）
├─ doc/                     # 文档目录
│  ├─ 项目操作文档.md         # 详细操作手册
│  ├─ 项目需求书.md           # 需求文档
│  └─ 项目操作文档.pdf        # PDF版本操作手册
├─ screenshots/             # 操作截图
│  ├─ 1.程序主页面.png
│  ├─ 2.新建任务.png
│  ├─ 3.数据预览.png
│  ├─ 4.邮件配置.png
│  ├─ 5.注册定时.png
│  ├─ 6.任务计划程序.png
│  └─ 7.收取邮件.png
└─ README.md                # 本说明文件
```

### 开发环境设置

1. 克隆仓库或下载源代码
2. 创建并激活虚拟环境（推荐）：
   ```bash
   python -m venv venv
   venv\Scripts\activate  # Windows
   # 或
   source venv/bin/activate  # Linux/Mac
   ```
3. 安装依赖：
   ```bash
   pip install -r requirements.txt
   ```
4. 运行程序：
   ```bash
   python app.py
   ```

### 命令行接口

程序提供以下命令行参数，方便调试和自动化调用：

```bash
# 以无头模式运行指定任务（主要供Windows任务计划调用）
python app.py --headless "你的任务名称"

# 立即测试运行一个任务
python app.py --test-task "你的任务名称"

# 列出所有已配置的任务
python app.py --list-tasks

# 注册一个定时任务
python app.py --register-task "你的任务名称"

# 注销一个已注册的定时任务
python app.py --unregister-task "你的任务名称"

# 显示首次运行配置向导
python app.py --first-time-setup
```

### 打包发布

使用PyInstaller将程序打包为单文件可执行程序：

```bash
pyinstaller app.spec
```

打包后的文件将生成在 `dist/` 目录下。

## 版本信息

- **当前版本**: v1.4.0
- **开发团队**: 扬州电信
- **开发者**: 黄维申 (18118256818)
- **技术架构**: Python + CustomTkinter + Pandas

## 技术支持

如果在使用过程中遇到问题，请：

1. 查看 `app.log` 文件中的详细日志
2. 查阅 [项目操作文档](./doc/项目操作文档.md) 获取详细使用指南
3. 联系技术支持：`huangweishen.js@chinatelecom.cn`

---

*百川数据助手 - 让数据处理变得简单高效 🚀*
